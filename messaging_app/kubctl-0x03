#!/bin/bash

set -e

echo "ğŸš€ Applying updated deployment (image v2.0)..."
kubectl apply -f messaging_app/blue_deployment.yaml

echo "â³ Monitoring rollout status of 'django-blue'..."
kubectl rollout status deployment/django-blue

echo "ğŸ” Fetching Minikube IP and django-service NodePort..."
MINIKUBE_IP=$(minikube ip)
NODE_PORT=$(kubectl get svc django-service -o=jsonpath='{.spec.ports[0].nodePort}')

echo "ğŸŒ Service URL: http://$MINIKUBE_IP:$NODE_PORT/"
echo "ğŸ§ª Starting rollout downtime test for 20 seconds..."

for i in {1..20}; do
  RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://$MINIKUBE_IP:$NODE_PORT/)
  if [[ "$RESPONSE" == "200" ]]; then
    echo "[$i] âœ… OK"
  else
    echo "[$i] âŒ FAIL (HTTP $RESPONSE)"
  fi
  sleep 1
done

echo "ğŸ“¦ Current pods with label app=django:"
kubectl get pods -l app=django -o wide
