#!/bin/bash

# Apply the updated deployment with image version 2.0
kubectl apply -f messaging_app/blue_deployment.yaml

# Monitor the rollout status
kubectl rollout status deployment/django-blue

# Get the service IP and port
MINIKUBE_IP=$(minikube ip)
NODE_PORT=$(kubectl get svc django-service -o=jsonpath='{.spec.ports[0].nodePort}')

echo "Testing for downtime during rollout..."

# Send requests continuously for 20 seconds
for i in {1..20}
do
  curl -s http://$MINIKUBE_IP:$NODE_PORT/ > /dev/null && echo "OK" || echo "FAIL"
  sleep 1
done

# Show the updated pods
kubectl get pods -l app=django
